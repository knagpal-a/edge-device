import{t as C}from"../__chunks__/toCamelCase.fmNGsVmq.js";import{t as V}from"../__chunks__/toClassName.DLENMWzL.js";function u(t,n){const i=document.createElement(t);return n&&(i.className=n),i}function h(t,n=null){const i=C(t);return n?`${i}-${C(n)}`:i}function E(t,n){const i=u("p","field-help-text");return i.textContent=t,i.id=`${n}-help`,i}function g(t,n="label",i=null,e=!1){const r=u(n);return r.textContent=t,i&&n==="label"&&r.setAttribute("for",i),e&&(r.dataset.required="true"),r}function k(t){const{type:n,field:i,required:e,default:r,placeholder:o}=t,a=u("input");return a.type=n||"text",a.id=h(i||"field"),a.name=a.id,a.required=e==="true",r&&(a.value=r),o&&(a.placeholder=o),a}function _(t){const{field:n,required:i,default:e,placeholder:r}=t,o=u("textarea");return o.id=h(n||"field"),o.name=o.id,o.required=i==="true",o.rows=5,e&&(o.value=e),r&&(o.placeholder=r),o}function O(t,n){const{type:i,field:e,default:r,required:o}=t,a=h(e||"field",n),s=u("input");return s.type=i||"text",s.id=a,s.name=h(e||"field"),s.value=n,s.checked=n===r,s.required=o==="true",s}function M(t,n){const{type:i,options:e,label:r,required:o}=t;if(!e)return null;const a=u("fieldset",`form-field ${i}-field`);if(n){const s=n.split("-")[0];a.dataset.controller=s,a.dataset.condition=n}return a.append(g(r||"","legend",null,o==="true")),e.split(",").forEach(s=>{const l=s.trim(),d=O(t,l),c=u("span"),f=g(l,"label",d.id);f.prepend(d,c),a.append(f)}),a}async function j(t){const n=await fetch(t),{data:i}=await n.json();return i.map(r=>{const{option:o,value:a}=r,s=u("option");return o&&a?(s.value=a,s.textContent=o):o&&!a?(s.value=o,s.textContent=o):a&&!o&&(s.value=a,s.textContent=a),s})}function B(t,n){const{type:i,options:e,field:r,label:o,required:a,placeholder:s}=t;if(!e)return null;const l=u("div",`form-field ${i||"text"}-field`);if(n){const c=n.split("-")[0];l.dataset.controller=c,l.dataset.condition=n}l.append(g(o||"","label",h(r||"field"),a==="true"));const d=u("select");if(d.id=h(r||"field"),d.name=d.id,d.required=a==="true",l.append(d),s){const c=u("option");c.value="",c.textContent=s,c.disabled=!0,c.selected=!0,d.append(c)}try{const c=new URL(e);j(c).then(f=>{d.append(...f)})}catch{e.split(",").forEach(f=>{const p=f.trim(),b=u("option");b.value=p,b.textContent=p,d.append(b)})}return l}function P(t,n){const{label:i,required:e,default:r}=t,o=u("div","form-field toggle-field");if(n){const d=n.split("-")[0];o.dataset.controller=d,o.dataset.condition=n}const a=O({...t,type:"checkbox"},r||"true");a.setAttribute("role","switch"),a.setAttribute("aria-checked",String(a.checked)),a.addEventListener("change",()=>{a.setAttribute("aria-checked",String(a.checked))});const s=u("span"),l=g(i||"","label",a.id,e==="true");return l.prepend(a,s),o.append(l),o}function U(t){const{type:n,label:i}=t,e=u("button");return e.className="button",e.type=n||"button",e.textContent=i||"",n==="reset"&&e.classList.add("secondary"),e}function W(t,n){const{target:i}=t,e=i.name;n.has(e)&&[...n.get(e)||[]].forEach(o=>{const a=o.closest(".form-field"),{condition:s}=a.dataset,l=s?s.includes(V(i.value)):!1;a.setAttribute("aria-hidden",String(!l)),l?(o.dataset.originalRequired==="true"&&o.setAttribute("required",""),o.removeAttribute("tabindex")):(o.removeAttribute("required"),o.setAttribute("tabindex","-1"))})}function D(t,n){n.forEach((i,e)=>{let r=null;const o=t.querySelector(`[name="${e}"]:checked`),a=t.querySelector(`select[name="${e}"]`);if(o?r=o.value:a&&(r=a.value),r){const s=r;i.forEach(l=>{const d=l.closest(".form-field"),{condition:c}=d.dataset,f=c?c.includes(V(s)):!1;d.setAttribute("aria-hidden",String(!f)),l.hasAttribute("required")&&(l.dataset.originalRequired||(l.dataset.originalRequired="true"),f||l.removeAttribute("required")),f?l.removeAttribute("tabindex"):l.setAttribute("tabindex","-1")})}else i.forEach(s=>{s.closest(".form-field").setAttribute("aria-hidden","true"),s.hasAttribute("required")&&(s.dataset.originalRequired||(s.dataset.originalRequired="true"),s.removeAttribute("required")),s.setAttribute("tabindex","-1")})})}function H(t){const n=[...t.querySelectorAll("[data-controller]")],i=new Map;n.forEach(e=>{const r=e.querySelector("input, textarea, select"),{controller:o}=e.dataset;r&&o&&(i.has(o)||i.set(o,[]),(i.get(o)||[]).push(r),r&&r.id&&t.querySelectorAll(`[name="${o}"]`).forEach(s=>{const d=(s.getAttribute("aria-controls")||"").split(" ").filter(c=>c);d.includes(r.id)||d.push(r.id),s.setAttribute("aria-controls",d.join(" ")),r.setAttribute("aria-controlledby",s.id)}))}),D(t,i),t.addEventListener("change",e=>{W(e,i)})}function F(t,n=!0){[...t.elements].forEach(i=>{const e=i;e&&"disabled"in e&&(e.disabled=n)})}function J(t){const n={};return[...t.elements].forEach(i=>{const e=i;e.name&&!e.disabled&&(e.type==="radio"?e.checked&&(n[e.name]=e.value):e.type==="checkbox"?e.checked&&(n[e.name]=n[e.name]?`${n[e.name]},${e.value}`:e.value):n[e.name]=e.value)}),n}async function z(t){try{const n=J(t);if(F(t),!t.dataset.action)throw new Error("Missing form action");const i=await fetch(t.dataset.action,{method:"POST",body:JSON.stringify({data:n}),headers:{"Content-Type":"application/json"}});if(i.ok)t.dataset.confirmation&&(window.location.href=t.dataset.confirmation);else{const e=await i.text();throw new Error(e)}}catch(n){console.error(n)}finally{F(t,!1)}}function G(t,n,i){t.dataset.action=n;const e=i.find(r=>r.type==="confirmation");e&&(t.dataset.confirmation=e.label||e.default),t.addEventListener("submit",r=>{if(r.preventDefault(),t.reportValidity())z(t);else{const a=t.querySelector(":invalid:not(fieldset)");a&&(a.focus(),a.scrollIntoView({behavior:"smooth",block:"center"}),a.setAttribute("aria-invalid","true"))}}),t.addEventListener("input",r=>{const o=r.target;o!=null&&o.hasAttribute("aria-invalid")&&o.validity.valid&&o.removeAttribute("aria-invalid")})}function I(t){const{type:n,label:i,help:e,field:r,conditional:o}=t,a=o||null,s=r||"field";if(n==="hidden")return k(t);if(n==="submit"||n==="reset")return U(t);if(n==="radio"||n==="checkbox"){const p=M(t,a);if(p&&e){const b=E(e,h(s));p.append(b)}return p||u("div")}if(n==="toggle"){const p=P(t,a);if(e){const b=E(e,h(s));p.append(b)}return p}if(n==="select"){const p=B(t,a);if(p&&e){const b=E(e,h(s));p.append(b)}return p||u("div")}const l=u("div",`form-field ${n}-field`);if(a){const p=a.split("-")[0];l.dataset.controller=p,l.dataset.condition=a}const d=h(s);l.append(g(i||"","label",d,t.required==="true"));let c;e&&(c=E(e,d),l.append(c));const f=n==="textarea"?_(t):k(t);return n==="textarea"?l.append(f):l.firstChild?l.insertBefore(f,l.firstChild.nextSibling):l.append(f),c&&f.setAttribute("aria-describedby",c.id),l}function K(t,n){const i=u("form");i.setAttribute("novalidate","");const e=[];if(t.forEach(r=>{r.type==="submit"||r.type==="reset"?e.push(r):r.type!=="confirmation"&&i.append(I(r))}),e.length){const r=u("div","button-wrapper");e.forEach(o=>r.append(I(o))),i.append(r)}return H(i),n&&G(i,n,t),i}function m(t,n,i=""){const e=t.find(r=>r.field===n);return e?e.default?e.default:e.value?e.value:i:i}function Q(t,n){const i=m(n,"otpFieldName","otp"),e=Number(m(n,"resendTimerSeconds","30")),r=Number(m(n,"resendLimit","3")),o=Number(m(n,"otpErrorThreshold","5")),a=m(n,"resendLimitMessage","Resend OTP limit exhausted."),s=m(n,"otpErrorRedirect",""),l=m(n,"resendLabel","Resend OTP"),d=m(n,"resendLoaderLabel","Resend available in"),c=t.querySelector(`input[name="${C(i)}"]`);if(!c)return;const f=c.closest(".form-field");if(!f)return;const p=u("div","otp-resend"),b=u("div","otp-resend__loader"),L=u("span","otp-resend__loader-text"),S=u("span","otp-resend__timer");b.append(L,S);const y=u("button","otp-resend__button");y.type="button",y.textContent=l;const w=u("div","otp-resend__message");w.textContent=a,p.append(b,y,w),f.append(p);let T=0,x;const A=v=>{b.style.display=v==="loading"?"flex":"none",y.style.display=v==="ready"?"inline-flex":"none",w.style.display=v==="limit"?"block":"none"},N=v=>{let q=Number.isFinite(v)?v:0;L.textContent=d,A("loading");const R=()=>{S.textContent=` ${q}s`,q<=0&&(x!==void 0&&window.clearInterval(x),x=void 0,A("ready")),q-=1};R(),x=window.setInterval(R,1e3)};N(e),y.addEventListener("click",()=>{if(T+=1,T>r){A("limit");return}t.dispatchEvent(new CustomEvent("otp:resend",{bubbles:!0})),N(e)});let $=0;t.addEventListener("submit",()=>{c&&!c.checkValidity()&&($+=1,o&&$>=o&&s&&(window.location.href=s))})}function Z(t){t.style.visibility="hidden";const n=[...t.querySelectorAll("a[href]")],[i,e]=n.map(r=>r.href);if(i){const r=new IntersectionObserver(o=>{o.forEach(async a=>{if(a.isIntersecting){try{const s=await fetch(new URL(i,window.location.origin));if(!s.ok)throw new Error(`${s.status}: ${s.statusText}`);const{data:l}=await s.json();if(!l)throw new Error(`No form fields at ${i}`);const d=K(l,e);Q(d,l),t.replaceChildren(d),t.removeAttribute("style")}catch(s){console.error("Could not build form from",i,s),t.parentElement&&t.parentElement.remove()}r.disconnect()}})},{threshold:0});r.observe(t)}else console.error("Unable to create form without source"),t.parentElement&&t.parentElement.remove()}export{Z as default};
//# sourceMappingURL=form.js.map
